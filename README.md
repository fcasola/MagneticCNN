# Magnetic_CNN
Convolutional Neural Nets for magnetism problems.

## Aim
This code tests whether CNNs can "learn" the laws of magnetism
and are capable of reconstructing magnetization patterns given the field 
that they produce.

This code is inspired by recent publications addressing the possibility 
of machine learning algorithms to learn the laws of physics, e.g.:

https://arxiv.org/pdf/1607.03597.pdf

For the particular case of magnetism, we start from the formalism 
derived by us in a recent publication at Harvard:

https://arxiv.org/abs/1611.00673

In this first version, the magnetization is assumed to be collinear but
its orientation and spatial distribution is not known and will be the target 
of the learning process.

## Model

![Alt text](readme_img/training_1.png?raw=true "model for the convolutional net implemented")

In the present model, we generate Ns randomly defined magnetization patterns. The magnetization is collinear, has elliptical-like shape (see image above, on a NpxNp = 32x32 pixel grid) and directions in space (parametrized by polar and azimuthal angle q,p) are sampled uniformly. For each magnetization we compute the magnetic field using the "Compute_Bz" function in the "Create_TrainingCNN" module. Data are then saved in a hierarchical data format (.h5) file as [q,p,m,Bz] with dimensions [Ns x (2 + 2* Np**2 )]. The (m,Bz) pair is then used as the (y,x) label/feature of the cnn. 
 
![Alt text](readme_img/Scheme_cnn.png?raw=true "model for the convolutional net implemented")

The .h5 dataset is fed for training into a cnn mimicking the one in https://arxiv.org/pdf/1607.03597.pdf. The scheme for the cnn is in the figure above. At prediction time, the user can feed the network using the module "Predict_cnn" using a lossless .png picture of arbitrary resolution (see python Predict_cnn.py -h for detailed help). A test dataset and learning parameters are already included in this github version.


### Prerequisites

- Python 3.6
- [Tensorflow 1.2.1](https://pypi.python.org/pypi/tensorflow/1.2.1)
- [SciPy](http://www.scipy.org/install.html)
- [h5py](http://www.h5py.org/)
- [Progressbar](https://pypi.python.org/pypi/progressbar2/3.18.1)
- [argparse](https://docs.python.org/3/library/argparse.html)

### Installing
```
Dataset and trained model are contained in the folder data/Training and data/Learned but can also be generated by the user by typing: 

git clone https://github.com/fcasola/MagneticCNN 
cd MagneticCNN/bin
python magnetic_cnn

To run predictions type:

cd MagneticCNN/magn_CNN
python Predict_cnn.py -h

and read the instructions.

A simple example can run by typing:

cd MagneticCNN/magn_CNN
python Predict_cnn.py -e

The example will be reconstructing the elliptical shape for the magnetization defined in data/Config/test_shape.cfg
All predictions will be saved and fed from the folder data/Learned

```
### Configuration File
```
The configuration file is in data/Config/config_training.cfg. 
You can change it as per your need. 

With the parameters below one can modify the parameters of the whole model.
Here is what the default configuration file looks like:

[Dataset]
# Default size of the generated training set in case none is specified
Ntrain_ex: 5000
# x,y pixels of the training set
img_size: [32,32]
# Specifies the number of points per pixels used to get 
# more accurate finite-element calculations
finer_grid: 4
# Randomly generate training magnetization shapes
# of max pixel size equivalent to rmax_v
rmax_v: 5

[model]
# Activation function for the neurons
act_type: relu
# Layer 1
# Convolution; kernel size and  [Width,Height]
k_filt_str_lyr1: [3,3]
# Convolution; number of filters
Depth_lyr1: 16
# Pooling for layer and 2: pool size [width,height]
Pool1_str_lyr1: [2,2]
# Pooling for layer and 2: pool size [width,height]
Pool2_str_lyr1: [2,2]
# Layer 2 
# Convolution; kernel size and  [Width,Height]
k_filt_str_lyr2: [3,3]
# Convolution; number of filters
Depth_lyr2: 16
# Layer 3 and subsequents
# Convolution; kernel size and  [Width,Height]
k_filt_str_lyr3: [3,3]
# Convolution; number of filters
Depth_lyr3: 16

[training]
# learning rate for the model
learn_rate: 0.1
# number of cycles through the whole training set
epochs: 200
# batch size for parameters update
batch_size: 2 
# ration training to validation model
Train_2_Valid: 0.6
# number to rescale small number inputs of the net
Multiplier: 1e15

[paths]
# folder where to save training data
save_train_set: ..\data\Training
# folder where to save learning data
save_learned: ..\data\Learned
# folder where to save prediction data
save_predictions: ..\data\Predictions

```

### About the modules
'''
# Create_TrainingCNN.py 
Produces the training set generating 2D magnetization patterns,
chosen to be ellipses of random axes and tilt. The module contains 
the function Compute_Bz, capable of finite element computation of 
the stray field given a certain magnetization pattern.

usage: Create_TrainingCNN.py [-h] [-o] [-n]
Create training data for the MCNN.

optional arguments:
  -h, --help      show this help message and exit
  -o , --Output   Filename for the hdf5 output
  -n , --Ndata    Number of training samples (integer)

# config.py 
- Import the configuration file

# Learning_cnn.py

usage: Learning_cnn.py [-h] [-o]
Training a CNN for magnetic problems.
optional arguments:
  -h, --help      show this help message
  -o, --Output    Filename prefix for saving tensorflow output 

# Predict_cnn.py

usage: Predict_cnn.py [-h] [-e] [-i] [-r ] [-c ] [-d] [-t] [-ms]
    Making predictions based on the trained cnn.
    The module takes as input an 8-bit pixels, black and white png image
    representing the stray field and creates an image with the same resolution
    representing the estimate of the cnn for a spatially varying collinear magnetization.
    Notes:
    1 - In using this function (see parameter definitions below),
    remember that the current model holds in the limit t<<d.
    2 - The b/w image containing the stray field is defined such that
    b/w (0-255) is the min/max of the field in Gauss.
    3 - The output is saved with similar conventions as in 2), where
    now b/w is 0/1 in Ms units. Look at "*_predicted.png"

optional arguments:
  -h, --help          show this help message and exit
  -e, --example       Creates exemplary Bz data/label for the cnn using a test shape specified in the ''Config'' folder.
  -i , --Image        Image name for the stray field.
                      The Image must be in the ''Predictions'' folder.
  -r  , --XYrange     Spcify width and height of the stray field image [in meters].
  -c  , --Caxrange    Spcify minimum and maximum value of the field [in Gauss].
  -d , --Distance     Distance of the stray field to the magnetization plane [in meters].
  -t , --thickness    Thickness of the magnetic layer [in meters].
  -ms , --Ms          Maximum scalar value for the nominal saturation magnetization of
                      the layer [in A/m].
'''

## Results

![Alt text](readme_img/results_1.png?raw=true "Target magnetization (left). Stray field input to the CNN (center) and interpolated output using the current training (right).")

Target magnetization (left). Stray field input to the CNN (center) and interpolated output using the current training (right)

![Alt text](readme_img/results_2.png?raw=true "Loss function vs epochs time using the config file parameters specified above.")

Loss function vs epochs time using the config file parameters specified above. Training data of 3000 images with elliptical shapes of random orientation, posiiton, size and tilt. Loss on the validation set (2000 images) at the final step is 9.55*10-4.



